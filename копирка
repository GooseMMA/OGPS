#!/usr/bin/env python
# admin/keygen.py
# –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–ª—é—á–µ–π: –ø—ã—Ç–∞–µ—Ç—Å—è –≤–∑—è—Ç—å —Å–µ–∫—Ä–µ—Ç –∏–∑ core/license_manager.py, –∏–Ω–∞—á–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é.

import sys, os, json, base64, argparse, hashlib, hmac
from datetime import datetime, timedelta

# –ü–æ–ø—Ä–æ–±—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ–∫—Ä–µ—Ç –∏–∑ core/license_manager, –µ—Å–ª–∏ –æ–Ω —Ç–∞–º –µ—Å—Ç—å
secret_bytes = None
try:
    # –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –≤ sys.path –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    if root not in sys.path:
        sys.path.insert(0, root)
    import core.license_manager as lm_mod
    # –≤–æ–∑–º–æ–∂–Ω—ã–µ –∏–º–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª–µ —Å –ª–∏—Ü–µ–Ω–∑–∏—è–º–∏
    for name in ("SECRET_KEY", "_SECRET", "SECRET", "SECRET_BYTES", "SECRET_KEY_BYTES"):
        if hasattr(lm_mod, name):
            val = getattr(lm_mod, name)
            if isinstance(val, bytes):
                secret_bytes = val
            elif isinstance(val, str):
                secret_bytes = val.encode()
            break
except Exception:
    secret_bytes = None

# fallback builtin (—Ç–µ—Å—Ç–æ–≤—ã–π) ‚Äî –∏–∑–º–µ–Ω—è–π —Ç—É—Ç –µ—Å–ª–∏ —Ö–æ—á–µ—à—å
FALLBACK_SECRET = b"UltraSecretKeyForSignature_v1"

def sign_data(secret: bytes, raw: str) -> str:
    return hmac.new(secret, raw.encode(), hashlib.sha256).hexdigest()

def encode_token(secret: bytes, hwid: str, days: int, activation_window_days: int = 30) -> str:
    expires = (datetime.utcnow() + timedelta(days=days)).strftime("%Y-%m-%d %H:%M:%S")
    payload = {"hwid": hwid, "exp": expires}
    raw = json.dumps(payload, separators=(',',':'))
    sig = sign_data(secret, raw)
    token_obj = {"data": payload, "sig": sig}
    token_b64 = base64.b64encode(json.dumps(token_obj, separators=(',',':')).encode()).decode()
    return token_b64

def main():
    parser = argparse.ArgumentParser(description="Admin license key generator (uses core/license_manager secret if available)")
    parser.add_argument("--days", type=int, default=7, help="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–µ–π—Å—Ç–≤–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏ (–ø–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏)")
    parser.add_argument("--hwid", type=str, required=True, help="HWID —Ü–µ–ª–∏ (—É–∫–∞–∂–∏ HWID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)")
    parser.add_argument("--window", type=int, default=30, help="Activation window (days) ‚Äî –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ")
    args = parser.parse_args()

    # –≤—ã–±–µ—Ä–µ–º —Å–µ–∫—Ä–µ—Ç
    secret = secret_bytes
    if secret is None:
        print("‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç—å —Å–µ–∫—Ä–µ—Ç –∏–∑ core/license_manager.py")
        print("  –í–∞—Ä–∏–∞–Ω—Ç—ã: 1) —É–±–µ–¥–∏—Å—å, —á—Ç–æ core/license_manager.py —Å–æ–¥–µ—Ä–∂–∏—Ç SECRET_KEY –∏–ª–∏ _SECRET;")
        print("           2) –≤–≤–µ–¥–∏ —Å–µ–∫—Ä–µ—Ç –≤—Ä—É—á–Ω—É—é; 3) –∏—Å–ø–æ–ª—å–∑—É–π –∑–∞–ø–∞—Å–Ω–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π (–Ω–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞).")
        answer = input("–í–≤–µ–¥–∏—Ç–µ 'm' —á—Ç–æ–±—ã –≤–≤–µ—Å—Ç–∏ —Å–µ–∫—Ä–µ—Ç –≤—Ä—É—á–Ω—É—é, Enter —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–ø–∞—Å–Ω–æ–π: ").strip().lower()
        if answer == 'm':
            s = input("–í—Å—Ç–∞–≤—å —Å–µ–∫—Ä–µ—Ç (—Å—Ç—Ä–æ–∫—É): ").strip()
            secret = s.encode()
        else:
            secret = FALLBACK_SECRET
            print("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–ø–∞—Å–Ω–æ–π —Å–µ–∫—Ä–µ—Ç (FALLBACK). –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –Ω–∞—Å—Ç–æ—è—â–∏–π —Å–µ–∫—Ä–µ—Ç.")

    token = encode_token(secret, args.hwid, args.days, activation_window_days=args.window)
    print("\\n‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Ç–æ–∫–µ–Ω:")
    print(token)
    print(f"üîí –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω {args.days} –¥–Ω–µ–π (—Å –º–æ–º–µ–Ω—Ç–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏).")

if __name__ == "__main__":
    main()