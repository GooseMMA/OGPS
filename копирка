import cv2
import numpy as np
import mss
import threading
import time

# HSV диапазон воды
LOWER = np.array([85, 60, 60])
UPPER = np.array([115, 255, 255])

# Глобальная переменная кадра
latest_frame = None
processed_frame = None

# ===== ПОТОК ЗАХВАТА =====
def capture_thread():
    global latest_frame
    sct = mss.mss()

    while True:
        img = sct.grab(sct.monitors[1])
        frame = np.array(img)[:, :, :3]  # BGR, цвета НЕ ИСПОРЧЕНЫ
        latest_frame = frame


# ===== ПОТОК ОБРАБОТКИ =====
def processing_thread():
    global latest_frame, processed_frame

    kernel = np.ones((5, 5), np.uint8)

    while True:
        if latest_frame is None:
            continue

        frame = latest_frame

        # уменьшение для скорости
        small = cv2.resize(frame, (0,0), fx=0.5, fy=0.5)

        hsv = cv2.cvtColor(small, cv2.COLOR_BGR2HSV)
        mask = cv2.inRange(hsv, LOWER, UPPER)

        mask = cv2.morphologyEx(mask, cv2.MORPH_CLOSE, kernel)

        contours, _ = cv2.findContours(mask, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

        for cnt in contours:
            if cv2.contourArea(cnt) > 2000:
                cv2.drawContours(small, [cnt], -1, (0, 255, 0), 2)

        processed_frame = small


# ===== ЗАПУСК ПОТОКОВ =====
t1 = threading.Thread(target=capture_thread, daemon=True)
t2 = threading.Thread(target=processing_thread, daemon=True)
t1.start()
t2.start()

cv2.namedWindow("FAST", cv2.WINDOW_NORMAL)

last_time = time.time()

while True:
    if processed_frame is not None:
        cv2.imshow("FAST", processed_frame)

        # FPS вывод
        now = time.time()
        fps = 1 / (now - last_time)
        last_time = now
        print(f"FPS: {fps:.1f}", end="\r")

    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cv2.destroyAllWindows()