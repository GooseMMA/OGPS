import cv2
import numpy as np
import time
import os
import mss

# === НАСТРОЙКА: HSV-диапазон для воды ===
LOWER_HSV_WATER = np.array([85, 60, 60])
UPPER_HSV_WATER = np.array([115, 255, 255])

# === НАСТРОЙКА: Путь к шаблонам ===
TEMPLATE_DIR = "templates"

# === Быстрая загрузка шаблонов ===
templates = []
for filename in os.listdir(TEMPLATE_DIR):
    if filename.endswith(".png") or filename.endswith(".jpg"):
        path = os.path.join(TEMPLATE_DIR, filename)
        img = cv2.imread(path)
        if img is not None:
            templates.append((cv2.resize(img, (0, 0), fx=0.5, fy=0.5), img.shape[:2]))

if not templates:
    raise FileNotFoundError("В папке templates нет изображений!")


def detect_and_draw(frame):
    """Ускоренная обработка кадра"""
    # уменьшаем для ускорения в 2 раза
    scale = 0.5
    small = cv2.resize(frame, (0,0), fx=scale, fy=scale)

    hsv = cv2.cvtColor(small, cv2.COLOR_BGR2HSV)
    mask = cv2.inRange(hsv, LOWER_HSV_WATER, UPPER_HSV_WATER)

    # Морфология
    kernel = np.ones((5, 5), np.uint8)
    mask = cv2.morphologyEx(mask, cv2.MORPH_CLOSE, kernel)

    # Контуры воды
    contours, _ = cv2.findContours(mask, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    for cnt in contours:
        if cv2.contourArea(cnt) > 2000:
            cv2.drawContours(small, [cnt], -1, (0, 255, 0), 2)

    # Поиск шаблонов (ускоренный)
    best_val = 0
    best_loc = None
    best_w = best_h = 0

    for temp, (h, w) in templates:
        result = cv2.matchTemplate(small, temp, cv2.TM_CCOEFF_NORMED)
        _, max_val, _, max_loc = cv2.minMaxLoc(result)

        if max_val > best_val:
            best_val = max_val
            best_loc = max_loc
            best_w, best_h = w//2, h//2

    if best_val > 0.55:
        top_left = best_loc
        bottom_right = (top_left[0] + best_w, top_left[1] + best_h)
        cv2.rectangle(small, top_left, bottom_right, (0, 0, 255), 2)

    return small


# === ОСНОВНОЙ ЦИКЛ ===
print("Оптимизированный режим запущен (FPS ↑).")

window = "Albion FAST MODE"
cv2.namedWindow(window, cv2.WINDOW_AUTOSIZE)
cv2.setWindowProperty(window, cv2.WND_PROP_TOPMOST, 1)

sct = mss.mss()

while True:
    start = time.time()

    # Быстрый захват экрана
    screenshot = sct.grab(sct.monitors[1])
    frame = np.array(screenshot)[:, :, :3]  # убираем альфа-канал
    frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)

    result = detect_and_draw(frame)

    cv2.imshow(window, result)

    fps = 1 / (time.time() - start)
    print(f"FPS: {fps:.1f}", end="\r")

    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cv2.destroyAllWindows()