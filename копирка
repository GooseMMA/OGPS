import sys, os, argparse, json, base64, hashlib
from datetime import datetime, timedelta

# üîß –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from core.hwid import get_hwid


def generate_license(hwid: str, days: int):
    """–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞."""
    expires = datetime.utcnow() + timedelta(days=days)
    payload = {
        "hwid": hwid,
        "exp": expires.strftime("%Y-%m-%d %H:%M:%S"),
    }

    # –ü—Ä–æ—Å—Ç–∞—è –ø–æ–¥–ø–∏—Å—å (–¥–ª—è —Ç–µ—Å—Ç–∞)
    secret = "SUPER_SECRET_KEY"
    data_str = json.dumps(payload)
    signature = hashlib.sha256((data_str + secret).encode()).hexdigest()

    license_data = {
        "data": payload,
        "sig": signature,
    }

    encoded = base64.urlsafe_b64encode(json.dumps(license_data).encode()).decode()
    return encoded


def main():
    parser = argparse.ArgumentParser(description="License Key Generator")
    parser.add_argument("hwid", help="HWID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞")
    parser.add_argument("--days", type=int, default=7, help="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–µ–π—Å—Ç–≤–∏—è –ª–∏—Ü–µ–Ω–∑–∏–∏")
    args = parser.parse_args()

    key = generate_license(args.hwid, args.days)
    print("\n‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–ª—é—á:")
    print(key)
    print(f"\nüîí –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω {args.days} –¥–Ω–µ–π.")


if __name__ == "__main__":
    main()